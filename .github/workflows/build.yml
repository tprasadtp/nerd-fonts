name: build
on:
  push:
    branches:
      - "*"
    tags:
      - "*"
  pull_request:
    branches:
      - master
      - dev

jobs:
  build:
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2

    - name: Install FontForge
      run: |
        sudo add-apt-repository ppa:fontforge/fontforge -y -u
        sudo apt-get install --no-install-recommends --yes fontforge python-pip  python-configparser

    - name: Prepare
      run: make prepare

    - name: LS
      run: |
        ls -R vendor
        ls -R build

    - name: Build Cascadia Regular
      run: make cascadia-regular

    - name: Build Cascadia Italic
      run: make cascadia-italic

    - name: Build Cascadia Mono
      run: make cascadia-mono

    - name: Build Fantasque-Sans-Mono
      run: make fantasque

    - name: Build FiraCode
      run: make firacode

    - name: Build Ubuntu Regular
      run: make ubuntu-regular

    - name: Build Ubuntu Mono
      run: make ubuntu-mono

    - name: LS
      run: ls -R build

    # checksums
    - name: Generate checksums
      run: |
        make release-notes
        make checksums
        cat build/SHA256SUMS.txt

    # Upload
    - name: Upload CascadiaCode
      uses: actions/upload-artifact@v2
      with:
        name:  CascadiaCode
        path: build/Cascadia/

    # Fantasque Sans Mono
    - name: Upload Fantasque-Sans-Mono
      uses: actions/upload-artifact@v2
      with:
        name:  Fantasque-Sans-Mono
        path: build/Fantasque/

    # FiraCode Sans Mono
    - name: Upload FiraCode
      uses: actions/upload-artifact@v2
      with:
        name:  FiraCode
        path: build/FiraCode/

    # Ubuntu
    - name: Upload Ubuntu
      uses: actions/upload-artifact@v2
      with:
        name:  Ubuntu
        path: build/Ubuntu/

    - name: Release
      if: startsWith(github.ref, 'refs/tags/v')
      run: ./scripts/release.sh
